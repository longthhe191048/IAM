<img width="1715" height="428" alt="image" src="https://github.com/user-attachments/assets/c00ed24f-b0dc-4977-834f-e437fe09a96f" /># r10-4 Bypassing Poison IVY's Lock file
## Understanding how Poison IVY locking the file
* Poison IVY - a RAT (Remote Access Trojan)
* It allows an attacker to take control of a compromised Windows machine: logging keystrokes, capturing screens/video, file transfers, system administration commands, password theft, etc.
* How it work: 
```
[Attacker / Operator]
        |
        |  craft & host payload (malicious EXE/doc, trojanized installer, etc.)
        v
   [Delivery: Phishing / Drive-by / USB]
        |
        |  victim opens/executes payload
        v
   [Victim PC — Poison Ivy CLIENT installed]
   ┌────────────────────────────────────────────┐
   │ - Installs backdoor agent (runs as a process) │
   │ - Attempts persistence (service, registry, etc.)│
   │ - Opens outbound connection to C2 (reverse TCP)│
   └────────────────────────────────────────────┘
        |
        |  Encrypted/obfuscated channel (outbound)
        v
   [Command & Control (C2) Server / Panel]
   ┌────────────────────────────────────────────┐
   │ - Sends commands (exec, browse files, capture)│
   │ - Receives keystrokes, screenshots, files    │
   │ - GUI for operator to manage many victims    │
   └────────────────────────────────────────────┘
        |
        v
   [Post-compromise capabilities]
   ┌────────────────────────────────────────────┐
   │ - File upload/download (exfiltration)        │
   │ - Keylogger / credential theft               │
   │ - Remote shell / process control             │
   │ - Lateral movement (use harvested creds)     │
   │ - Deploy additional payloads (escalation)    │
   └────────────────────────────────────────────┘

```
* In the victim PC, Some variants of the Poison Ivy14 trojan lock files by specifying a restrictive file-sharing mode.
* Understanding `CreateFile`
```
HANDLE WINAPI CreateFile(
  __in          LPCTSTR lpFileName,
  __in          DWORD dwDesiredAccess,
  __in          DWORD dwShareMode,
  __in          LPSECURITY_ATTRIBUTES lpSecurityAttributes,
  __in          DWORD dwCreationDisposition,
  __in          DWORD dwFlagsAndAttributes,
  __in          HANDLE hTemplateFile
 );
```
* By setting `dwShareMode` to `0`, we can't do the following function `FILE_SHARE_DELETE`, `FILE_SHARE_READ`, `FILE_SHARE_WRITE`
* When the trojan execute, we can see it injecting this code in their PE
```
CreateFile(“c:\\windows\\system32\\toli.exe”,
                      GENERIC_READ, 
                      0, // no file sharing
                      NULL,          
                      OPEN_EXISTING, 
                      0, NULL)
```

## Replicate locking function
By using the following script, we can create a locking function to lock a file so we can't copy, delete or write to the file
```
# try_open_winapi.py
import sys
import win32file, win32con, pywintypes

path = sys.argv[1] if len(sys.argv) > 1 else r"C:\Users\Public\a.txt"

try:
    h = win32file.CreateFile(
        path,
        win32con.GENERIC_READ | win32con.GENERIC_WRITE,
        0,
        None,
        win32con.OPEN_EXISTING,
        win32con.FILE_ATTRIBUTE_NORMAL,
        None
    )
    print("Unexpectedly opened file (handle):", h)
    win32file.CloseHandle(h)
except pywintypes.error as e:
    print("CreateFile failed:", e)   # pywintypes.error contains (winerror, func, message)

```
i will run the file

<img width="948" height="307" alt="image" src="https://github.com/user-attachments/assets/2f6bb73b-e0e1-4505-8ebd-c030f23dc214" />

in another terminal, i will try to delete, copy and write to the file

<img width="2000" height="708" alt="image" src="https://github.com/user-attachments/assets/6359cd9d-aa85-4878-909b-ac9286fa0389" />

using `handle.exe`, we can see the following detail
```
handle a.txt
```

<img width="1715" height="428" alt="image" src="https://github.com/user-attachments/assets/cbf6fbac-8f1e-4610-b5a2-6acf046dd3a0" />

## Release lock file
Either terminate my script, press enter in the terminal to release or using this command
```
handle -C 0x150 -p 7876
```

<img width="1125" height="474" alt="image" src="https://github.com/user-attachments/assets/7f874430-461e-4028-843e-74d5a5779903" />

Checking result

<img width="1427" height="711" alt="image" src="https://github.com/user-attachments/assets/6aee45c0-7f96-480b-be44-70e586846eac" />

## Reference
* [Poison Ivy](https://www.cyber.nj.gov/threat-landscape/malware/trojans/poison-ivy)
* [PoisonIvy](https://attack.mitre.org/software/S0012/)
* [Backdoor:W32/PoisonIvy](https://www.f-secure.com/v-descs/backdoor-w32-poisonivy.shtml)
