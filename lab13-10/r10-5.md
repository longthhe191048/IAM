# r10-5 Bypassing Conficker’s File System ACL Restrictions
## Objective
* Understand what is Conficker
* Understand ACL
* Understand how Conficker restrict ACL
* Bypass ACL Restriction

## Knowledge
* Conficker, also known as Downup, Downadup and Kido.
* A computer worms targeting Microsoft Windows
* CVE‑2008‑4250
* A malicious RPC (Remote Procedure Call) request is crafted to exploit the buffer overflow in the `srvsvc` service
* An Access Control List (ACL) is a security mechanism that controls access to data and resources.
* Conficker will drop a `DLL` file to somewhere and then alter ACL so that it can only be executed.
<img width="720" height="400" alt="image" src="https://github.com/user-attachments/assets/54b4aadd-18ae-4984-98c0-28e20657bbb7" />

## Create ACL Restriction
Here is the script to run in python to restrict ACL to only Execute.
```
# acl_demo_exec.py  — Demonstrate setting execute-only NTFS ACL (lab-safe)
# Usage:
#   python acl_demo_exec.py restrict  C:\path\to\sample.exe
#   python acl_demo_exec.py restore   C:\path\to\sample.exe

import sys
import json
import os
import win32api
import win32con
import win32security

SDDL_INFO_FLAGS = (
    win32security.DACL_SECURITY_INFORMATION |
    win32security.OWNER_SECURITY_INFORMATION |
    win32security.GROUP_SECURITY_INFORMATION
)

def save_original_sddl(path):
    sd = win32security.GetFileSecurity(path, SDDL_INFO_FLAGS)
    sddl = win32security.ConvertSecurityDescriptorToStringSecurityDescriptor(
        sd, win32security.SDDL_REVISION_1, SDDL_INFO_FLAGS
    )
    meta = {"sddl": sddl}
    with open(path + ".acl_backup.json", "w", encoding="utf-8") as f:
        json.dump(meta, f)
    return sddl

def load_original_sddl(path):
    with open(path + ".acl_backup.json", "r", encoding="utf-8") as f:
        return json.load(f)["sddl"]

def get_sid(name):
    sid, domain, _type = win32security.LookupAccountName(None, name)
    return sid

def get_current_user_sid():
    # e.g., "DESKTOP-ABC\\Alice"
    full = win32api.GetUserNameEx(win32con.NameSamCompatible)
    return get_sid(full)

def restrict_acl_execute_only(path):
    # 1) Save original SDDL so we can restore later
    if not os.path.exists(path + ".acl_backup.json"):
        save_original_sddl(path)

    # 2) Build a new DACL that ALLOWS only: CurrentUser, Administrators, SYSTEM
    user_sid = get_current_user_sid()
    admins_sid = get_sid("BUILTIN\\Administrators")
    system_sid = get_sid("NT AUTHORITY\\SYSTEM")

    # Use GENERIC_EXECUTE to give execute-only rights (no read/write)
    ACCESS = win32con.GENERIC_EXECUTE

    acl = win32security.ACL()
    acl.AddAccessAllowedAce(win32security.ACL_REVISION, ACCESS, user_sid)
    acl.AddAccessAllowedAce(win32security.ACL_REVISION, ACCESS, admins_sid)
    acl.AddAccessAllowedAce(win32security.ACL_REVISION, ACCESS, system_sid)

    # 3) Create a new security descriptor with no inheritance
    sd_new = win32security.SECURITY_DESCRIPTOR()
    sd_new.SetSecurityDescriptorDacl(1, acl, 0)  # present=1, dacl=acl, defaulted=0

    # preserve owner/group from old descriptor
    sd_old = win32security.GetFileSecurity(path, SDDL_INFO_FLAGS)
    sd_new.SetSecurityDescriptorOwner(sd_old.GetSecurityDescriptorOwner(), False)
    sd_new.SetSecurityDescriptorGroup(sd_old.GetSecurityDescriptorGroup(), False)

    # 4) Apply the new DACL
    win32security.SetFileSecurity(path, win32security.DACL_SECURITY_INFORMATION, sd_new)

    print("[OK] DACL set to EXECUTE-ONLY for CurrentUser, Administrators, SYSTEM (inheritance removed).")
    print("    Original ACL saved to:", path + ".acl_backup.json")

def restore_acl(path):
    if not os.path.exists(path + ".acl_backup.json"):
        print("[!] No backup found:", path + ".acl_backup.json")
        sys.exit(1)

    sddl = load_original_sddl(path)
    sd = win32security.ConvertStringSecurityDescriptorToSecurityDescriptor(
        sddl, win32security.SDDL_REVISION_1
    )
    win32security.SetFileSecurity(path, SDDL_INFO_FLAGS, sd)
    print("[OK] Original ACL restored from backup.")

def main():
    if len(sys.argv) != 3 or sys.argv[1] not in {"restrict", "restore"}:
        print("Usage:")
        print("  python acl_demo_exec.py restrict  C:\\path\\to\\sample.exe")
        print("  python acl_demo_exec.py restore   C:\\path\\to\\sample.exe")
        sys.exit(1)

    cmd, path = sys.argv[1], sys.argv[2]
    if not os.path.exists(path):
        print("[!] File not found:", path)
        sys.exit(1)

    try:
        if cmd == "restrict":
            restrict_acl_execute_only(path)
        else:
            restore_acl(path)
    except Exception as e:
        print("[!] Error:", e)
        sys.exit(1)

if __name__ == "__main__":
    main()

```
Because of how windows defend for conficker, which is give to the owner `READ_CONTROL` and `WRITE_DAC`, i will firstly change the owner of the file. i will get the `kernel32.dll` and change their name
```
copy C:\Windows\System32\kernel32.dll C:\Users\WDchocopie\Downloads\test.dll
icacls "C:\Users\WDchocopie\Downloads\test.dll" /setowner "NT AUTHORITY\SYSTEM"
```
<img width="2161" height="546" alt="image" src="https://github.com/user-attachments/assets/1d7354b3-f361-45e5-a3fd-e9017dd558aa" />

After that, check their ACL using this command
```
accesschk.exe -v "C:\Users\WDchocopie\Downloads\test.dll"
```
<img width="2026" height="684" alt="image" src="https://github.com/user-attachments/assets/bb27564f-332b-4eb1-8d7a-302bf05c51a9" />

Now run the script
```
python acl.py restrict test.dll
```
<img width="1448" height="310" alt="image" src="https://github.com/user-attachments/assets/606b82f4-a06a-4a5c-877b-7d648550665a" />

Checking the ACL again
```
accesschk.exe -v "C:\Users\WDchocopie\Downloads\test.dll"
```
<img width="1124" height="537" alt="image" src="https://github.com/user-attachments/assets/2b6c6c5b-2e38-4f56-8e44-1e1c0104cc66" />

We could see everything change to `FILE_EXECUTE`(Except the owner of the file)
## Restore ACL
Using this command
```
takeown /F "C:\Users\WDchocopie\Downloads\test.dll"
icacls "C:\Users\WDchocopie\Downloads\test.dll" /reset
```
<img width="1853" height="832" alt="image" src="https://github.com/user-attachments/assets/e7412e83-c151-4508-a919-5bb378c837ff" />

## Reference 
* [What is the Conficker worm](https://www.cybereason.com/blog/what-is-the-conficker-worm)
* [Conficker](https://www.radware.com/security/ddos-knowledge-center/ddospedia/conficker/)
* [Access Control List (ACL) in cyber security: Beneficial for all, critical for some](https://www.dataguard.com/blog/acl-access-control-list/)
