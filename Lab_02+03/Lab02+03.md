# Lab 02 and 03
<!-- TOC start (generated with https://github.com/derlin/bitdowntoc) -->

- [Lab 02 and 03](#lab-02-and-03)
   * [Requirement](#requirement)
   * [Lab objective](#lab-objective)
   * [Pre-lab Knowledge](#pre-lab-knowledge)
   * [Lab walkthrough and definition](#lab-walkthrough-and-definition)
   * [Reference ](#reference)

<!-- TOC end -->
## Requirement
* kali linux / any debian / linux VM

## Lab objective
This lab require us to install and use ClamAV on any debian system. 

## Pre-lab Knowledge
* [ClamAV](https://www.kali.org/tools/clamav/) or ClamAntiVirus is an anti-virus toolkit for Unix.
* Use: e-mail scanning on mail gateways
* Utilities:
  * flexible and scalable multi-threaded daemon
  * a command line scanner and advanced tool for automatic database updates

## Lab walkthrough and definition
1. First, turn on VMs and update our package manager
`sudo apt update`

<img width="1920" height="1080" alt="image" src="https://github.com/user-attachments/assets/1a4432d5-c78f-487a-bf19-bd442264b597" />

3. install `clamav`
`sudo apt install clamav -y`

<img width="1920" height="1080" alt="image" src="https://github.com/user-attachments/assets/a401f5b0-bf29-4c9b-8b0c-a26b1610f735" />

4. Checking if `clamav` has successfully installed
`clamscan --version`

<img width="451" height="129" alt="image" src="https://github.com/user-attachments/assets/27cb0cfb-dd38-42dd-84a8-cdc9abdc7435" />

5. Testing `clamav`

* Update `clamav` database
`sudo freshclam`

<img width="832" height="279" alt="image" src="https://github.com/user-attachments/assets/c21480c7-1b05-4b2e-beda-e2090fd23636" />

This was cause by the `freshclam` service is still running. if you want to update manually then you have to stop it.

`sudo systemctl status clamav-freshclam`

<img width="1458" height="491" alt="image" src="https://github.com/user-attachments/assets/79ad35e0-1bb6-43b6-be12-c005ddab0fe1" />

```
sudo systemctl stop clamav-freshclam
sudo freshclam
sudo systemctl start clamav-freshclam
```

<img width="1083" height="203" alt="image" src="https://github.com/user-attachments/assets/73b68d20-7f43-4260-ba51-99afd014706c" />


* Scanning file
First i will create a folder that hold malware

```
mkdir malware
cd malware
```

<img width="381" height="154" alt="image" src="https://github.com/user-attachments/assets/deb67dc1-a2ac-4e89-9bda-c8a4b71d4d7a" />

next, we will create this to let `clamav` scan

```
printf '%s' 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.com
clamscan --infected --remove=no .
```

<img width="610" height="258" alt="image" src="https://github.com/user-attachments/assets/070b9c5d-d572-4f3f-b620-435a3dc125ef" />


* Creating signature for `clamav` and scan it
In order to detect malware and other file-based threats, ClamAV relies on signatures to differentiate clean and malicious/unwanted files

**Read more** -> [Signature](https://docs.clamav.net/manual/Signatures.html)

I will only test in body-signature, especially on **Extended signature** and **Hash-based Signature**

**Extended signature**

We need to create a text-file `.ndb` with the following format

`MalwareName:TargetType:Offset:HexSignature[:min_flevel:[max_flevel]]`
* `MalwareName`: The virus name. [Readme](https://docs.clamav.net/manual/Signatures.html#signature-names)
* `TargetType`: A number specifying the type of the target file. [Readme](https://docs.clamav.net/appendix/FileTypes.html#Target-Types)
* `Offset`: An asterisk or a decimal number n possibly combined with a special modifier:
  * \* = any
  * n = absolute offset
  * EOF-n = end of file minus n bytes
* `HexSignature`: The body-based content. [Readme](https://docs.clamav.net/manual/Signatures/BodySignatureFormat.html)
* `min_flevel`: (optional) The minimum ClamAV engine that the file type signature works with. See the FLEVEL reference for details. To be used in the event that file type support has been recently added.
* `max_flevel`: (optional, requires `min_flevel`) The maximum ClamAV engine that the file type signature works with. To be used in the event that file type support has been recently removed.

After explainatiom. I can craft a sigature where:
* Virus name: `linux.malware.backdoor-longthhe191048-0001-1 `
* Target type: `0` -> stand for any file
* Offset: `*` -> stand for any
* Hex signature: `49414d206973207468652062657374` -> stand for "IAM is the best"

**Result:** `linux.malware.backdoor-longthhe191048-0001-1:0:*:49414d206973207468652062657374`

let's create and test it
```
echo "IAM is the best" > "test"
echo "linux.malware.backdoor-longthhe191048-0001-1:0:*:49414d206973207468652062657374" > "sig.ndb"
clamscan -d sig.ndb --remove=no
```

<img width="1051" height="407" alt="image" src="https://github.com/user-attachments/assets/31824a87-d6b5-4024-81f1-f78af72ce479" />

**Hash-based signature**

We need to create a `.hsb` file with the following format

`HashString:FileSize:MalwareName`

By using `sigtool`, we can craft something like:

`bc241de771d6e4ffcab98337e06cc3fa64262221:16:test`

<img width="425" height="86" alt="image" src="https://github.com/user-attachments/assets/8825a726-07fb-4872-b28f-8755368661cc" />

**Result**

<img width="675" height="357" alt="image" src="https://github.com/user-attachments/assets/ef850e0f-07e3-4184-b64c-e6657890928d" />

## Reference 
* [Clamav Signature](https://docs.clamav.net/manual/Signatures.html)
* [Kali linux Clamav](https://www.kali.org/tools/clamav/)
